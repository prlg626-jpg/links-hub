name: Ingest link from Issue Form

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  ingest:
    if: contains(github.event.issue.labels.*.name, 'nuevo-link')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Update links.json
        shell: bash
        run: |
          node <<'NODE'
          const fs = require('fs');

          // 1) Leer evento de GitHub (Issue)
          const eventPath = process.env.GITHUB_EVENT_PATH;
          const event = JSON.parse(fs.readFileSync(eventPath, 'utf8'));
          const body = (event.issue && event.issue.body) ? event.issue.body : '';

          // 2) Parser del Issue Form (toma valores bajo cada encabezado "### ...")
          function pick(label) {
            const re = new RegExp(`###\\s+${label}\\s*\\n\\n([\\s\\S]*?)(\\n\\n###|\\n\\n$)`, 'i');
            const m = body.match(re);
            if (!m) return '';
            return m[1].trim();
          }

          const title = pick('Título del link') || 'Sin título';
          const url = pick('URL') || '';
          const category = pick('Categoría') || 'General';
          const note = pick('Nota o descripción') || '';

          if (!url) {
            console.log('No URL found. Skipping update.');
            process.exit(0);
          }

          // 3) Fecha (UTC) YYYY-MM-DD
          const now = new Date();
          const yyyy = now.getUTCFullYear();
          const mm = String(now.getUTCMonth() + 1).padStart(2, '0');
          const dd = String(now.getUTCDate()).padStart(2, '0');
          const date = `${yyyy}-${mm}-${dd}`;

          // 4) Leer y actualizar links.json
          const file = 'links.json';
          const raw = fs.readFileSync(file, 'utf8');
          const data = JSON.parse(raw);

          if (!Array.isArray(data.links)) data.links = [];

          // Evitar duplicados exactos por URL
          const exists = data.links.some(l => (l.url || '').trim() === url.trim());
          if (exists) {
            console.log('URL already exists. No changes.');
          } else {
            data.links.unshift({ title, url, note, category, date });
            fs.writeFileSync(file, JSON.stringify(data, null, 2) + '\n', 'utf8');
            console.log('Link added.');
          }
          NODE

      - name: Commit changes (if any)
        shell: bash
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "links-hub-bot"
          git config user.email "links-hub-bot@users.noreply.github.com"
          git add links.json
          git commit -m "Add link from issue #${{ github.event.issue.number }}"
          git push

      - name: Comment back with site URL
        uses: actions/github-script@v7
        with:
          script: |
            const site = `https://${context.repo.owner}.github.io/${context.repo.repo}/`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `Listo. Ya agregué el link al hub. Revisa aquí: ${site}`
            });

      - name: Close issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: "closed"
            });
